name: pdufa-daily-build-and-upload-qc

on:
  schedule:
    # Runs daily at 03:20 UTC (~05:20 Asia/Jerusalem in winter / ~06:20 in summer)
    - cron: "20 3 * * *"
  workflow_dispatch: {}

concurrency:
  group: pdufa-daily-build-and-upload
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "Calendar Agent/requirements.txt"

      - name: Sync with remote main
        run: |
          set -e
          git fetch origin main
          git checkout main
          git pull --rebase origin main

      - name: Install dependencies
        run: pip install -r "Calendar Agent/requirements.txt"

      - name: Build CSVs
        env:
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
        run: python "Calendar Agent/src/main.py"

      - name: Configure Git author
        run: |
          git config user.name "pdufa-bot"
          git config user.email "pdufa-bot@users.noreply.github.com"

      - name: Commit changes (if any)
        id: commit
        run: |
          set -e
          git add "Calendar Agent/data/pdufa_master.csv" "Calendar Agent/data/blank.csv" "Calendar Agent/data/state.json" || true

          if git diff --cached --quiet; then
            echo "committed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: daily PDUFA update $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "committed=true" >> "$GITHUB_OUTPUT"

      - name: Push commit (if committed)
        id: push
        if: steps.commit.outputs.committed == 'true'
        run: |
          set -e
          # Small retry helps if remote advanced between pull and push
          for i in 1 2 3; do
            if git push origin HEAD:main; then
              echo "pushed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Push failed; rebasing and retrying ($i/3)..."
            git fetch origin main
            git pull --rebase origin main || true
          done

          echo "pushed=false" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Upload to QuantConnect ObjectStore (only if pushed)
        if: steps.push.outputs.pushed == 'true'
        env:
          QC_USER_ID: ${{ secrets.QC_USER_ID }}
          QC_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
          QC_ORGANIZATION_ID: ${{ secrets.QC_ORGANIZATION_ID }}
          QC_KEY: "PDUFA_Updated_Daily.csv"
          FILE_PATH: "Calendar Agent/data/pdufa_master.csv"
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_RUN: ${{ github.run_number }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python - << 'PY'
          import base64, hashlib, time, requests, os, datetime, pathlib, textwrap, sys

          BASE_URL = "https://www.quantconnect.com/api/v2"
          user_id = os.environ["QC_USER_ID"]
          api_token = os.environ["QC_API_TOKEN"]
          org_id = os.environ["QC_ORGANIZATION_ID"]
          key = os.environ["QC_KEY"]
          file_path = os.environ["FILE_PATH"]

          tg_token = os.environ.get("TG_TOKEN")
          tg_chat  = os.environ.get("TG_CHAT_ID")

          repo = os.environ.get("GITHUB_REPO", "")
          runn = os.environ.get("GITHUB_RUN", "")
          sha  = os.environ.get("GITHUB_SHA", "")
          short_sha = sha[:7] if sha else ""

          def send_tg(msg: str):
              if not tg_token or not tg_chat:
                  print("Telegram not configured; skipping notify.")
                  return
              try:
                  requests.post(
                      f"https://api.telegram.org/bot{tg_token}/sendMessage",
                      data={"chat_id": tg_chat, "text": msg, "disable_web_page_preview": True},
                      timeout=10
                  )
              except Exception as e:
                  print(f"Telegram failed: {e}")

          try:
              if not pathlib.Path(file_path).is_file():
                  raise FileNotFoundError(f"File not found: {file_path}")

              ts = str(int(time.time()))
              hashed = hashlib.sha256(f"{api_token}:{ts}".encode()).hexdigest()
              auth = base64.b64encode(f"{user_id}:{hashed}".encode()).decode()
              headers = {"Authorization": f"Basic {auth}", "Timestamp": ts}

              with open(file_path, "rb") as f:
                  files = {"objectData": f.read()}
              data = {"organizationId": org_id, "key": key}

              r = requests.post(f"{BASE_URL}/object/set", headers=headers, data=data, files=files, timeout=60)
              r.raise_for_status()
              ok = r.json().get("success", False)

              now_utc = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

              if ok:
                  msg = textwrap.dedent(f"""\
                      QC ObjectStore updated
                      Key: {key}
                      File: {file_path}
                      Repo: {repo} (run #{runn}, {short_sha})
                      Time: {now_utc}
                  """).strip()
                  print(msg)
                  send_tg(msg)
              else:
                  msg = textwrap.dedent(f"""\
                      QC upload failed
                      Key: {key}
                      File: {file_path}
                      Repo: {repo} (run #{runn}, {short_sha})
                      Time: {now_utc}
                      Response: {r.text[:500]}
                  """).strip()
                  print(msg)
                  send_tg(msg)
                  sys.exit(1)

          except Exception as e:
              now_utc = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
              msg = textwrap.dedent(f"""\
                  Exception during upload
                  Key: {key}
                  File: {file_path}
                  Repo: {repo} (run #{runn}, {short_sha})
                  Time: {now_utc}
                  Error: {e}
              """).strip()
              print(msg)
              send_tg(msg)
              sys.exit(1)
          PY
